# api/support_api.py
from flask import Flask, request, jsonify
from flask_cors import CORS
import sys
import os

# ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ãŸã‚ã«ãƒ‘ã‚¹ã‚’è¿½åŠ 
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))
from models.support_models import (
    add_support_transaction,
    get_creator_earnings, 
    get_support_history,
    get_user_points,
    update_user_points
)

app = Flask(__name__)
CORS(app)

@app.route('/api/support/send', methods=['POST'])
def send_support():
    """æ”¯æ´ã‚’é€ã‚‹"""
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        creator_id = data.get('creator_id')
        points_amount = data.get('points_amount')
        message = data.get('message', '')
        
        # å…¥åŠ›å€¤æ¤œè¨¼
        if not all([user_id, creator_id, points_amount]):
            return jsonify({'error': 'å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™'}), 400
            
        if points_amount <= 0:
            return jsonify({'error': 'ãƒã‚¤ãƒ³ãƒˆæ•°ã¯1ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'}), 400
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèª
        current_points = get_user_points(user_id)
        if current_points < points_amount:
            return jsonify({'error': 'ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™'}), 400
        
        # ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—
        new_points = current_points - points_amount
        if not update_user_points(user_id, new_points):
            return jsonify({'error': 'ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'}), 500
        
        # æ”¯æ´å–å¼•ã‚’è¨˜éŒ²
        if add_support_transaction(user_id, creator_id, points_amount, message):
            return jsonify({
                'message': 'æ”¯æ´ãŒå®Œäº†ã—ã¾ã—ãŸ',
                'remaining_points': new_points
            }), 200
        else:
            # å¤±æ•—ã—ãŸå ´åˆã¯ãƒã‚¤ãƒ³ãƒˆã‚’æˆ»ã™
            update_user_points(user_id, current_points)
            return jsonify({'error': 'æ”¯æ´ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'}), 500
            
    except Exception as e:
        return jsonify({'error': f'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/support/history/<int:user_id>', methods=['GET'])
def get_user_support_history(user_id):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ”¯æ´å±¥æ­´ã‚’å–å¾—"""
    try:
        limit = request.args.get('limit', 50, type=int)
        history = get_support_history(user_id=user_id, limit=limit)
        
        return jsonify({
            'history': history,
            'count': len(history)
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/creator/<int:creator_id>/earnings', methods=['GET'])
def get_creator_earnings_api(creator_id):
    """ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã®åç›Šæƒ…å ±ã‚’å–å¾—"""
    try:
        earnings = get_creator_earnings(creator_id)
        if earnings is not None:
            return jsonify(earnings), 200
        else:
            return jsonify({'error': 'åç›Šæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}), 500
            
    except Exception as e:
        return jsonify({'error': f'åç›Šæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/creator/<int:creator_id>/support-history', methods=['GET'])
def get_creator_support_history(creator_id):
    """ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãŒå—ã‘ãŸæ”¯æ´å±¥æ­´ã‚’å–å¾—"""
    try:
        limit = request.args.get('limit', 50, type=int)
        history = get_support_history(creator_id=creator_id, limit=limit)
        
        return jsonify({
            'history': history,
            'count': len(history)
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'æ”¯æ´å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/user/<int:user_id>/points', methods=['GET'])
def get_user_points_api(user_id):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ã‚’å–å¾—"""
    try:
        points = get_user_points(user_id)
        return jsonify({'points': points}), 200
        
    except Exception as e:
        return jsonify({'error': f'ãƒã‚¤ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/support/recent', methods=['GET'])
def get_recent_support():
    """æœ€è¿‘ã®æ”¯æ´å±¥æ­´ã‚’å–å¾—"""
    try:
        limit = request.args.get('limit', 20, type=int)
        history = get_support_history(limit=limit)
        
        return jsonify({
            'history': history,
            'count': len(history)
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'æœ€è¿‘ã®æ”¯æ´å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/api/support/stats', methods=['GET'])
def get_support_stats():
    """æ”¯æ´çµ±è¨ˆæƒ…å ±ã‚’å–å¾—"""
    try:
        import sqlite3
        
        conn = sqlite3.connect('fan_platform.db')
        cursor = conn.cursor()
        
        # çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        cursor.execute('''
            SELECT 
                COUNT(*) as total_transactions,
                SUM(points_amount) as total_points,
                COUNT(DISTINCT user_id) as total_supporters,
                COUNT(DISTINCT creator_id) as supported_creators
            FROM support_transactions
        ''')
        
        stats = cursor.fetchone()
        conn.close()
        
        return jsonify({
            'total_transactions': stats[0] or 0,
            'total_points': stats[1] or 0,
            'total_supporters': stats[2] or 0,
            'supported_creators': stats[3] or 0
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}'}), 500

@app.route('/health', methods=['GET'])
def health_check():
    """ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return jsonify({'status': 'OK', 'service': 'Support API'}), 200

if __name__ == '__main__':
    print("ğŸš€ æ”¯æ´API ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...")
    print("ğŸ“¡ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:")
    print("  POST /api/support/send - æ”¯æ´ã‚’é€ã‚‹")
    print("  GET  /api/support/history/<user_id> - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ”¯æ´å±¥æ­´")
    print("  GET  /api/creator/<creator_id>/earnings - ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼åç›Š")
    print("  GET  /api/creator/<creator_id>/support-history - ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼æ”¯æ´å±¥æ­´")
    print("  GET  /api/user/<user_id>/points - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜")
    print("  GET  /api/support/recent - æœ€è¿‘ã®æ”¯æ´å±¥æ­´")
    print("  GET  /api/support/stats - æ”¯æ´çµ±è¨ˆæƒ…å ±")
    print("  GET  /health - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯")
    print("ğŸŒ http://localhost:5002")
    
    app.run(debug=True, port=5002)
